name: NTRLI Engine â€“ AutoFix + APK Build

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-22.04

    env:
      ANDROID_HOME: /home/runner/android-sdk
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      PATH: /home/runner/android-sdk/cmdline-tools/latest/bin:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/build-tools/36.1.0:$PATH

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Python deps (engine + build)
        run: |
          if [ -f .github/scripts/requirements.txt ]; then
            pip install -r .github/scripts/requirements.txt
          fi
          pip install buildozer cython

      # -----------------------------
      # AUTOFIX: PYTHON PACKAGE
      # -----------------------------
      - name: Autofix Python package structure
        run: |
          REQUIRED_DIRS=(
            engine
            engine/commands
            engine/router
            engine/self_improvement
            engine/state
            engine/trace
            engine/utils
          )

          for d in "${REQUIRED_DIRS[@]}"; do
            mkdir -p "$d"
            touch "$d/__init__.py"
          done

      # -----------------------------
      # ANDROID SDK BOOTSTRAP
      # -----------------------------
      - name: Install Android SDK command-line tools
        run: |
          mkdir -p $ANDROID_HOME
          cd $ANDROID_HOME
          curl -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q cmdline-tools.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ || true

      - name: Accept Android SDK licenses (NON-INTERACTIVE)
        run: |
          yes | sdkmanager --licenses

      - name: Install Android platform + build-tools
        run: |
          sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;36.1.0"

      # -----------------------------
      # VERIFY AIDL EXISTS
      # -----------------------------
      - name: Verify AIDL
        run: |
          which aidl
          aidl --version

      # -----------------------------
      # RUN ENGINE (SAFE)
      # -----------------------------
      - name: Run NTRLI Engine
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m engine.bootstrap

      # -----------------------------
      # BUILD APK WITH BUILDOZER
      # -----------------------------
      - name: Build APK with Buildozer
        run: |
          buildozer android debug

      # -----------------------------
      # PUBLISH APK
      # -----------------------------
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ntrli-apk
          path: bin/*.apk
