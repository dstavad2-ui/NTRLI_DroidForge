name: NTRLI Engine – Finalizer (Safe Auto-Fix)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  finalize:
    runs-on: ubuntu-22.04

    steps:
      # --------------------------------------------------
      # CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # PYTHON
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install script dependencies if present
        run: |
          if [ -f .github/scripts/requirements.txt ]; then
            pip install -r .github/scripts/requirements.txt
          fi

      # --------------------------------------------------
      # AUTO-FIX: ENGINE PACKAGE STRUCTURE
      # --------------------------------------------------
      - name: Normalize engine package layout
        run: |
          set -e
          echo "Normalizing Python package structure..."

          REQUIRED_DIRS=(
            "engine"
            "engine/commands"
            "engine/router"
            "engine/self_improvement"
            "engine/state"
            "engine/trace"
            "engine/utils"
          )

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ] && [ ! -f "$dir/__init__.py" ]; then
              echo "Adding __init__.py → $dir"
              touch "$dir/__init__.py"
            fi
          done

      # --------------------------------------------------
      # COMMIT SAFE FIXES ONLY (NON-WORKFLOW)
      # --------------------------------------------------
      - name: Commit engine fixes (safe scope)
        run: |
          set -e

          git reset .github/workflows || true

          if git status --porcelain | grep .; then
            echo "Committing safe auto-fixes..."
            git config user.name "ntrli-autofix-bot"
            git config user.email "autofix@ntrli.local"
            git add .
            git commit -m "auto-fix: normalize engine package structure"
            git push
          else
            echo "No safe fixes required."
          fi

      # --------------------------------------------------
      # VALIDATION (READ-ONLY)
      # --------------------------------------------------
      - name: Validate engine bootstrap (module-safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m engine.bootstrap
