name: NTRLI Engine – Finalizer (Auto-Fix + Normalize)

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  finalize:
    runs-on: ubuntu-22.04

    steps:
      # --------------------------------------------------
      # CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # PYTHON SETUP
      # --------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install script dependencies if present
        run: |
          if [ -f .github/scripts/requirements.txt ]; then
            pip install -r .github/scripts/requirements.txt
          fi

      # --------------------------------------------------
      # AUTO-FIX: PYTHON PACKAGE NORMALIZATION
      # --------------------------------------------------
      - name: Ensure engine is a valid Python package
        run: |
          set -e
          echo "Validating Python package structure..."

          REQUIRED_DIRS=(
            "engine"
            "engine/commands"
            "engine/router"
            "engine/self_improvement"
            "engine/state"
            "engine/trace"
            "engine/utils"
          )

          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ] && [ ! -f "$dir/__init__.py" ]; then
              echo "Adding missing __init__.py → $dir"
              touch "$dir/__init__.py"
            fi
          done

      # --------------------------------------------------
      # AUTO-FIX: INVALID WORKFLOW EXECUTION
      # --------------------------------------------------
      - name: Normalize workflow Python execution
        run: |
          set -e
          echo "Normalizing workflow execution patterns..."

          for file in .github/workflows/*.yml; do
            if grep -q "python engine/bootstrap.py" "$file"; then
              echo "Fixing execution pattern in $file"
              sed -i 's|python engine/bootstrap.py|python -m engine.bootstrap|g' "$file"
            fi
          done

      # --------------------------------------------------
      # AUTO-COMMIT FIXES (IF ANY)
      # --------------------------------------------------
      - name: Commit auto-fixes if required
        run: |
          if git status --porcelain | grep .; then
            echo "Auto-fixes detected. Committing..."
            git config user.name "ntrli-autofix-bot"
            git config user.email "autofix@ntrli.local"
            git add .
            git commit -m "auto-fix: normalize engine packaging and execution"
            git push
          else
            echo "No fixes required."
          fi

      # --------------------------------------------------
      # SAFE EXECUTION VALIDATION
      # --------------------------------------------------
      - name: Validate engine bootstrap (module-safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m engine.bootstrap
