name: Android Build Final

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - both

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for Android project
      id: check_project
      run: |
        if [ -f "settings.gradle.kts" ] || [ -f "settings.gradle" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Android project found"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  No Android project detected - will create"
        fi
        
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Initialize Android project structure
      if: steps.check_project.outputs.exists == 'false'
      run: |
        echo "üöÄ Initializing Android project structure..."
        
        # Create directories
        mkdir -p app/src/main/java/com/ntrli/droidforge
        mkdir -p app/src/main/res/{layout,values,drawable}
        mkdir -p app/src/main/res/mipmap-{hdpi,mdpi,xhdpi,xxhdpi,xxxhdpi}
        
        # Create settings.gradle.kts
        cat > settings.gradle.kts << 'SETTINGS'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "NTRLI_DroidForge"
        include(":app")
        SETTINGS
        
        # Create root build.gradle.kts with PRIMARY version
        cat > build.gradle.kts << 'BUILD'
        plugins {
            id("com.android.application") version "8.7.3" apply false
            id("org.jetbrains.kotlin.android") version "2.0.21" apply false
        }
        BUILD
        
        # Create app/build.gradle.kts
        cat > app/build.gradle.kts << 'APPBUILD'
        plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
        }
        android {
            namespace = "com.ntrli.droidforge"
            compileSdk = 35
            defaultConfig {
                applicationId = "com.ntrli.droidforge"
                minSdk = 24
                targetSdk = 35
                versionCode = 1
                versionName = "1.0.0"
                testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
            }
            buildTypes {
                release {
                    isMinifyEnabled = false
                    proguardFiles(
                        getDefaultProguardFile("proguard-android-optimize.txt"),
                        "proguard-rules.pro"
                    )
                }
            }
            compileOptions {
                sourceCompatibility = JavaVersion.VERSION_17
                targetCompatibility = JavaVersion.VERSION_17
            }
            kotlinOptions {
                jvmTarget = "17"
            }
            buildFeatures {
                viewBinding = true
            }
        }
        dependencies {
            implementation("androidx.core:core-ktx:1.15.0")
            implementation("androidx.appcompat:appcompat:1.7.0")
            implementation("com.google.android.material:material:1.12.0")
            implementation("androidx.constraintlayout:constraintlayout:2.2.0")
            testImplementation("junit:junit:4.13.2")
            androidTestImplementation("androidx.test.ext:junit:1.2.1")
            androidTestImplementation("androidx.test.espresso:espresso-core:3.6.1")
        }
        APPBUILD
        
        # Create proguard-rules.pro
        cat > app/proguard-rules.pro << 'PROGUARD'
        # NTRLI DroidForge ProGuard Rules
        -keepattributes *Annotation*
        -keepclassmembers class * {
            @android.webkit.JavascriptInterface <methods>;
        }
        -keep public class * extends android.app.Activity
        -keep public class * extends androidx.appcompat.app.AppCompatActivity
        PROGUARD
        
        # Create AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << 'MANIFEST'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:theme="@style/Theme.MaterialComponents.DayNight">
                <activity
                    android:name=".MainActivity"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        MANIFEST
        
        # Create MainActivity.kt
        cat > app/src/main/java/com/ntrli/droidforge/MainActivity.kt << 'MAIN'
        package com.ntrli.droidforge
        
        import android.os.Bundle
        import androidx.appcompat.app.AppCompatActivity
        import android.widget.TextView
        
        class MainActivity : AppCompatActivity() {
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                val textView = TextView(this).apply {
                    text = "üåø NTRLI DroidForge\n\nBuilt with precision.\nNo compromises."
                    textSize = 20f
                    setPadding(64, 64, 64, 64)
                }
                setContentView(textView)
            }
        }
        MAIN
        
        # Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'STRINGS'
        <resources>
            <string name="app_name">NTRLI DroidForge</string>
        </resources>
        STRINGS
        
        # Create colors.xml
        cat > app/src/main/res/values/colors.xml << 'COLORS'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="primary">#4CAF50</color>
            <color name="primary_dark">#388E3C</color>
            <color name="accent">#8BC34A</color>
        </resources>
        COLORS
        
        # Create gradle.properties
        cat > gradle.properties << 'PROPS'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.enableJetifier=true
        kotlin.code.style=official
        android.nonTransitiveRClass=false
        PROPS
        
        echo "‚úÖ Android project structure initialized"
        
    - name: Install Gradle wrapper (Primary - 8.11)
      id: gradle_primary
      continue-on-error: true
      run: |
        echo "üîß Installing Gradle wrapper 8.11 (primary)..."
        gradle wrapper --gradle-version 8.11 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.11 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.11 failed"
        fi
        
    - name: Install Gradle wrapper (Fallback 1 - 8.9)
      if: steps.gradle_primary.outputs.success != 'true'
      id: gradle_fallback1
      continue-on-error: true
      run: |
        echo "üîÑ Trying fallback: Gradle 8.9..."
        rm -rf gradle gradlew gradlew.bat
        
        # Update AGP to 8.6.1 for Gradle 8.9 compatibility
        if [ -f "build.gradle.kts" ]; then
          sed -i 's/id("com.android.application") version "[^"]*"/id("com.android.application") version "8.6.1"/' build.gradle.kts
          sed -i 's/id("org.jetbrains.kotlin.android") version "[^"]*"/id("org.jetbrains.kotlin.android") version "2.0.21"/' build.gradle.kts
        fi
        
        gradle wrapper --gradle-version 8.9 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.9 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.9 failed"
        fi
        
    - name: Install Gradle wrapper (Fallback 2 - 8.7)
      if: steps.gradle_fallback1.outputs.success != 'true'
      id: gradle_fallback2
      continue-on-error: true
      run: |
        echo "üîÑ Trying fallback: Gradle 8.7..."
        rm -rf gradle gradlew gradlew.bat
        
        # Update AGP to 8.5.2 for Gradle 8.7 compatibility
        if [ -f "build.gradle.kts" ]; then
          sed -i 's/id("com.android.application") version "[^"]*"/id("com.android.application") version "8.5.2"/' build.gradle.kts
          sed -i 's/id("org.jetbrains.kotlin.android") version "[^"]*"/id("org.jetbrains.kotlin.android") version "2.0.0"/' build.gradle.kts
        fi
        
        gradle wrapper --gradle-version 8.7 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.7 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.7 failed"
        fi
        
    - name: Verify Gradle installation
      run: |
        if [ ! -f "gradlew" ]; then
          echo "‚ùå All Gradle installations failed"
          exit 1
        fi
        echo "üìä Gradle version:"
        ./gradlew --version
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Run tests
      id: test
      continue-on-error: true
      run: |
        ./gradlew test --stacktrace || echo "‚ö†Ô∏è Tests failed but continuing"
        
    - name: Build Debug APK
      id: build_debug
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
      continue-on-error: true
      run: |
        echo "üî® Building Debug APK..."
        if ./gradlew assembleDebug --stacktrace --no-daemon; then
          echo "success=true" >> $GITHUB_OUTPUT
          DEBUG_APK=$(find app/build/outputs/apk/debug -name '*.apk' | head -n 1)
          echo "apk_path=$DEBUG_APK" >> $GITHUB_OUTPUT
          echo "‚úÖ Debug APK built successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Debug build failed"
        fi
        
    - name: Build Release APK
      id: build_release
      if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
      continue-on-error: true
      run: |
        echo "üî® Building Release APK..."
        if ./gradlew assembleRelease --stacktrace --no-daemon; then
          echo "success=true" >> $GITHUB_OUTPUT
          RELEASE_APK=$(find app/build/outputs/apk/release -name '*.apk' | head -n 1)
          echo "apk_path=$RELEASE_APK" >> $GITHUB_OUTPUT
          echo "‚úÖ Release APK built successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Release build failed"
        fi
      env:
        SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        
    - name: Get version info
      id: version
      run: |
        VERSION_NAME=$(grep -E 'versionName.*=.*"' app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/' || echo "1.0.0")
        VERSION_CODE=$(grep -E 'versionCode.*=.*[0-9]' app/build.gradle.kts | grep -oE '[0-9]+' || echo "1")
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "build_date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        
    - name: Rename APK files
      run: |
        if [ "${{ steps.build_debug.outputs.success }}" == "true" ] && [ -f "${{ steps.build_debug.outputs.apk_path }}" ]; then
          cp "${{ steps.build_debug.outputs.apk_path }}" "app-debug-v${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.build_date }}.apk"
          echo "‚úÖ Debug APK renamed"
        fi
        if [ "${{ steps.build_release.outputs.success }}" == "true" ] && [ -f "${{ steps.build_release.outputs.apk_path }}" ]; then
          cp "${{ steps.build_release.outputs.apk_path }}" "app-release-v${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.build_date }}.apk"
          echo "‚úÖ Release APK renamed"
        fi
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: steps.build_debug.outputs.success == 'true'
      with:
        name: debug-apk-v${{ steps.version.outputs.version_name }}
        path: app-debug-*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      if: steps.build_release.outputs.success == 'true'
      with:
        name: release-apk-v${{ steps.version.outputs.version_name }}
        path: app-release-*.apk
        retention-days: 90
        if-no-files-found: warn
        
    - name: Generate build summary
      if: always()
      run: |
        echo "# üöÄ NTRLI DroidForge Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Code:** ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.build_debug.outputs.success }}" == "true" ]; then
          echo "- ‚úÖ Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ùå Debug APK build failed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ steps.build_release.outputs.success }}" == "true" ]; then
          echo "- ‚úÖ Release APK built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ùå Release APK build failed" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 14
        if-no-files-found: ignore
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs
        path: |
          app/build/reports/
          build/reports/
          app/build/outputs/logs/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Cleanup Gradle Cache
      if: always()
      run: |
        rm -f ~/.gradle/caches/modules-2/modules-2.lock
        rm -f ~/.gradle/caches/modules-2/gc.properties
        
    - name: Check build success
      run: |
        if [ "${{ steps.build_debug.outputs.success }}" != "true" ] && [ "${{ steps.build_release.outputs.success }}" != "true" ]; then
          echo "‚ùå All builds failed"
          exit 1
        fi
        echo "‚úÖ At least one build succeeded"

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-apk-*/*.apk
          debug-apk-*/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üöÄ NTRLI DroidForge Release
          
          Automated build from GitHub Actions.
          Built with precision. No compromises.
          
          ### üì¶ Downloads
          - **Release APK**: Production-ready build
          - **Debug APK**: Development build with debugging
          
          ### üìù Installation
          1. Download the APK file
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install the APK
          
          üåø NTRLI DroidForge - Professional Android automation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
