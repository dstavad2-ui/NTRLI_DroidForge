name: Android Build Final

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Android project
        id: detect
        run: |
          if [ -f "settings.gradle" ] || [ -f "settings.gradle.kts" ]; then
            echo "android=true" >> $GITHUB_OUTPUT
          else
            echo "android=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # ✅ CRITICAL FIX — ANDROIDX ENABLEMENT
      - name: Ensure gradle.properties (AndroidX)
        run: |
          if [ ! -f gradle.properties ]; then
            cat > gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.caching=true
          EOF
          else
            grep -q "android.useAndroidX" gradle.properties || echo "android.useAndroidX=true" >> gradle.properties
            grep -q "android.enableJetifier" gradle.properties || echo "android.enableJetifier=true" >> gradle.properties
          fi

      - name: Initialize Android project (if missing)
        if: steps.detect.outputs.android == 'false'
        run: |
          mkdir -p app/src/main/java/com/ntrli/droidforge
          mkdir -p app/src/main/res/values

          cat > settings.gradle.kts << 'EOF'
          pluginManagement {
            repositories {
              google()
              mavenCentral()
              gradlePluginPortal()
            }
          }
          dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
              google()
              mavenCentral()
            }
          }
          rootProject.name = "NTRLI_DroidForge"
          include(":app")
          EOF

          cat > build.gradle.kts << 'EOF'
          plugins {
            id("com.android.application") version "8.4.2" apply false
            id("org.jetbrains.kotlin.android") version "1.9.24" apply false
          }
          EOF

          cat > app/build.gradle.kts << 'EOF'
          plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
          }

          android {
            namespace = "com.ntrli.droidforge"
            compileSdk = 34

            defaultConfig {
              applicationId = "com.ntrli.droidforge"
              minSdk = 24
              targetSdk = 34
              versionCode = 1
              versionName = "1.0.0"
            }

            buildTypes {
              debug {
                applicationIdSuffix = ".debug"
              }
              release {
                isMinifyEnabled = false
              }
            }

            compileOptions {
              sourceCompatibility = JavaVersion.VERSION_17
              targetCompatibility = JavaVersion.VERSION_17
            }

            kotlinOptions {
              jvmTarget = "17"
            }
          }

          dependencies {
            implementation("androidx.core:core-ktx:1.13.1")
            implementation("androidx.appcompat:appcompat:1.7.0")
            implementation("com.google.android.material:material:1.12.0")
          }
          EOF

          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <application
              android:label="NTRLI DroidForge"
              android:exported="true">
              <activity android:name=".MainActivity">
                <intent-filter>
                  <action android:name="android.intent.action.MAIN"/>
                  <category android:name="android.intent.category.LAUNCHER"/>
                </intent-filter>
              </activity>
            </application>
          </manifest>
          EOF

          cat > app/src/main/java/com/ntrli/droidforge/MainActivity.kt << 'EOF'
          package com.ntrli.droidforge

          import android.os.Bundle
          import androidx.appcompat.app.AppCompatActivity

          class MainActivity : AppCompatActivity() {
            override fun onCreate(savedInstanceState: Bundle?) {
              super.onCreate(savedInstanceState)
            }
          }
          EOF

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*','**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Generate Gradle Wrapper
        run: |
          gradle wrapper --gradle-version 8.6
          chmod +x gradlew

      - name: Clean
        run: ./gradlew clean --no-daemon

      - name: Run unit tests
        continue-on-error: true
        run: ./gradlew test --no-daemon

      - name: Build Debug APK
        if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
        run: ./gradlew assembleDebug --no-daemon

      - name: Build Release APK
        if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
        run: ./gradlew assembleRelease --no-daemon

      - name: Collect APKs
        run: |
          mkdir -p artifacts
          find app/build/outputs/apk -name "*.apk" -exec cp {} artifacts/ \;

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: artifacts/*.apk
          retention-days: 30
