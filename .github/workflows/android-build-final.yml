name: Android Build Final (DroidForge Aligned)

on:
  push:
    branches: [main, master, develop]
    tags: ['v*']
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false

jobs:
  build:
    name: Build DroidForge APK
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Hard validation of repository state ---
      - name: Validate DroidForge repository structure
        run: |
          test -f ./gradlew || { echo "❌ gradlew missing"; exit 1; }
          test -d ./gradle/wrapper || { echo "❌ gradle/wrapper missing"; exit 1; }
          test -d ./app || { echo "❌ app module missing"; exit 1; }
          test -f settings.gradle || test -f settings.gradle.kts || { echo "❌ settings.gradle(.kts) missing"; exit 1; }

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Ensure Gradle wrapper executable
        run: chmod +x ./gradlew

      # --- Primary objective: APKs ---
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      # --- Artifact handling ---
      - name: Collect APK artifacts
        run: |
          mkdir -p artifacts
          find app/build/outputs/apk -name "*.apk" -exec cp {} artifacts/ \;
          ls -lh artifacts

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: droidforge-apks
          path: artifacts/*.apk
          retention-days: 30

      # --- Optional diagnostics (non-blocking, informational only) ---
      - name: Android Lint (informational)
        continue-on-error: true
        run: ./gradlew lintDebug --no-daemon

      - name: Unit Tests (informational)
        continue-on-error: true
        run: ./gradlew test --no-daemon

  release:
    name: GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: droidforge-apks

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: "*.apk"
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
