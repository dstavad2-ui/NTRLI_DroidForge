name: Android Build Final

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'both'
        type: choice
        options:
          - debug
          - release
          - both

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Dkotlin.incremental=false

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check for Android project
      id: check_project
      run: |
        if [ -f "settings.gradle.kts" ] || [ -f "settings.gradle" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Android project found"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  No Android project detected - will create"
        fi
        
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Initialize Android project structure
      if: steps.check_project.outputs.exists == 'false'
      run: |
        echo "üöÄ Initializing Android project structure..."
        
        # Create directories
        mkdir -p app/src/main/java/com/ntrli/droidforge
        mkdir -p app/src/main/res/{layout,values,drawable}
        mkdir -p app/src/main/res/mipmap-{hdpi,mdpi,xhdpi,xxhdpi,xxxhdpi}
        
        # Create settings.gradle.kts
        cat > settings.gradle.kts << 'SETTINGS'
        pluginManagement {
            repositories {
                google {
                    content {
                        includeGroupByRegex("com\\.android.*")
                        includeGroupByRegex("com\\.google.*")
                        includeGroupByRegex("androidx.*")
                    }
                }
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "NTRLI_DroidForge"
        include(":app")
        SETTINGS
        
        # Create root build.gradle.kts - LATEST VERSIONS
        cat > build.gradle.kts << 'BUILD'
        plugins {
            id("com.android.application") version "8.13.2" apply false
            id("org.jetbrains.kotlin.android") version "2.2.21" apply false
        }
        
        tasks.register("clean", Delete::class) {
            delete(rootProject.layout.buildDirectory)
        }
        BUILD
        
        # Create app/build.gradle.kts
        cat > app/build.gradle.kts << 'APPBUILD'
        plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
        }
        
        android {
            namespace = "com.ntrli.droidforge"
            compileSdk = 36
            
            defaultConfig {
                applicationId = "com.ntrli.droidforge"
                minSdk = 24
                targetSdk = 36
                versionCode = 1
                versionName = "1.0.0"
                testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
                
                vectorDrawables {
                    useSupportLibrary = true
                }
            }
            
            buildTypes {
                release {
                    isMinifyEnabled = true
                    isShrinkResources = true
                    proguardFiles(
                        getDefaultProguardFile("proguard-android-optimize.txt"),
                        "proguard-rules.pro"
                    )
                }
                debug {
                    isMinifyEnabled = false
                    applicationIdSuffix = ".debug"
                    versionNameSuffix = "-DEBUG"
                }
            }
            
            compileOptions {
                sourceCompatibility = JavaVersion.VERSION_17
                targetCompatibility = JavaVersion.VERSION_17
            }
            
            kotlinOptions {
                jvmTarget = "17"
                freeCompilerArgs += listOf(
                    "-opt-in=kotlin.RequiresOptIn"
                )
            }
            
            buildFeatures {
                viewBinding = true
                buildConfig = true
            }
            
            packaging {
                resources {
                    excludes += "/META-INF/{AL2.0,LGPL2.1}"
                }
            }
        }
        
        dependencies {
            // Core Android
            implementation("androidx.core:core-ktx:1.15.0")
            implementation("androidx.appcompat:appcompat:1.7.0")
            
            // Material Design
            implementation("com.google.android.material:material:1.12.0")
            
            // ConstraintLayout
            implementation("androidx.constraintlayout:constraintlayout:2.2.0")
            
            // Lifecycle
            implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.8.7")
            
            // Testing
            testImplementation("junit:junit:4.13.2")
            androidTestImplementation("androidx.test.ext:junit:1.2.1")
            androidTestImplementation("androidx.test.espresso:espresso-core:3.6.1")
        }
        APPBUILD
        
        # Create proguard-rules.pro
        cat > app/proguard-rules.pro << 'PROGUARD'
        # NTRLI DroidForge ProGuard Rules
        -keepattributes *Annotation*
        -keepattributes SourceFile,LineNumberTable
        -keepattributes Signature
        -keepattributes *Annotation*
        
        # Keep Activities
        -keep public class * extends android.app.Activity
        -keep public class * extends androidx.appcompat.app.AppCompatActivity
        -keep public class * extends androidx.fragment.app.Fragment
        
        # Keep WebView JavaScript Interface
        -keepclassmembers class * {
            @android.webkit.JavascriptInterface <methods>;
        }
        
        # Kotlin
        -dontwarn kotlin.**
        -dontwarn kotlinx.**
        PROGUARD
        
        # Create AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << 'MANIFEST'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:tools="http://schemas.android.com/tools">
            
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:roundIcon="@mipmap/ic_launcher_round"
                android:supportsRtl="true"
                android:theme="@style/Theme.NTRLIDroidForge"
                tools:targetApi="36">
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:theme="@style/Theme.NTRLIDroidForge">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        MANIFEST
        
        # Create MainActivity.kt
        cat > app/src/main/java/com/ntrli/droidforge/MainActivity.kt << 'MAIN'
        package com.ntrli.droidforge
        
        import android.os.Bundle
        import android.widget.LinearLayout
        import android.widget.TextView
        import androidx.appcompat.app.AppCompatActivity
        import androidx.core.content.ContextCompat
        
        class MainActivity : AppCompatActivity() {
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                
                val layout = LinearLayout(this).apply {
                    orientation = LinearLayout.VERTICAL
                    setPadding(64, 64, 64, 64)
                    setBackgroundColor(ContextCompat.getColor(context, R.color.background))
                }
                
                val titleView = TextView(this).apply {
                    text = "üåø NTRLI DroidForge"
                    textSize = 28f
                    setTextColor(ContextCompat.getColor(context, R.color.text))
                    setPadding(0, 0, 0, 32)
                }
                
                val subtitleView = TextView(this).apply {
                    text = "Built with precision.\nNo compromises.\n\nVersion: ${BuildConfig.VERSION_NAME}"
                    textSize = 18f
                    setTextColor(ContextCompat.getColor(context, R.color.text))
                }
                
                layout.addView(titleView)
                layout.addView(subtitleView)
                setContentView(layout)
            }
        }
        MAIN
        
        # Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'STRINGS'
        <resources>
            <string name="app_name">NTRLI DroidForge</string>
        </resources>
        STRINGS
        
        # Create colors.xml
        cat > app/src/main/res/values/colors.xml << 'COLORS'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="primary">#4CAF50</color>
            <color name="primary_dark">#388E3C</color>
            <color name="accent">#8BC34A</color>
            <color name="background">#E8F5E9</color>
            <color name="text">#1B5E20</color>
            <color name="white">#FFFFFF</color>
            <color name="black">#000000</color>
        </resources>
        COLORS
        
        # Create themes.xml
        cat > app/src/main/res/values/themes.xml << 'THEMES'
        <resources xmlns:tools="http://schemas.android.com/tools">
            <style name="Theme.NTRLIDroidForge" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
                <item name="colorPrimary">@color/primary</item>
                <item name="colorPrimaryDark">@color/primary_dark</item>
                <item name="colorAccent">@color/accent</item>
                <item name="android:statusBarColor">@color/primary_dark</item>
            </style>
        </resources>
        THEMES
        
        # Create gradle.properties
        cat > gradle.properties << 'PROPS'
        org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8
        org.gradle.parallel=true
        org.gradle.caching=true
        org.gradle.configureondemand=true
        android.useAndroidX=true
        android.enableJetifier=true
        kotlin.code.style=official
        android.nonTransitiveRClass=false
        android.defaults.buildfeatures.buildconfig=true
        PROPS
        
        echo "‚úÖ Android project structure initialized"
        
    - name: Install Gradle wrapper (Primary - 8.13)
      id: gradle_primary
      continue-on-error: true
      run: |
        echo "üîß Installing Gradle 8.13 (LATEST STABLE)..."
        gradle wrapper --gradle-version 8.13 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version 2>&1 | grep -q "Gradle 8.13"; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "version=8.13" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.13 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.13 failed"
        fi
        
    - name: Install Gradle wrapper (Fallback 1 - 8.11)
      if: steps.gradle_primary.outputs.success != 'true'
      id: gradle_fallback1
      continue-on-error: true
      run: |
        echo "üîÑ Trying fallback: Gradle 8.11..."
        rm -rf gradle gradlew gradlew.bat
        
        # Update AGP to 8.11-compatible version
        if [ -f "build.gradle.kts" ]; then
          sed -i 's/id("com.android.application") version "[^"]*"/id("com.android.application") version "8.11.2"/' build.gradle.kts
          sed -i 's/id("org.jetbrains.kotlin.android") version "[^"]*"/id("org.jetbrains.kotlin.android") version "2.1.0"/' build.gradle.kts
        fi
        
        gradle wrapper --gradle-version 8.11 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version 2>&1 | grep -q "Gradle 8.11"; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "version=8.11" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.11 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.11 failed"
        fi
        
    - name: Install Gradle wrapper (Fallback 2 - 8.9)
      if: steps.gradle_fallback1.outputs.success != 'true'
      id: gradle_fallback2
      continue-on-error: true
      run: |
        echo "üîÑ Trying fallback: Gradle 8.9..."
        rm -rf gradle gradlew gradlew.bat
        
        # Update AGP and Kotlin for 8.9 compatibility
        if [ -f "build.gradle.kts" ]; then
          sed -i 's/id("com.android.application") version "[^"]*"/id("com.android.application") version "8.9.2"/' build.gradle.kts
          sed -i 's/id("org.jetbrains.kotlin.android") version "[^"]*"/id("org.jetbrains.kotlin.android") version "2.0.21"/' build.gradle.kts
          # Adjust compileSdk to 35 for older AGP
          sed -i 's/compileSdk = 36/compileSdk = 35/' app/build.gradle.kts
          sed -i 's/targetSdk = 36/targetSdk = 35/' app/build.gradle.kts
        fi
        
        gradle wrapper --gradle-version 8.9 --distribution-type all
        chmod +x gradlew
        if ./gradlew --version 2>&1 | grep -q "Gradle 8.9"; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "version=8.9" >> $GITHUB_OUTPUT
          echo "‚úÖ Gradle 8.9 installed successfully"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Gradle 8.9 failed"
        fi
        
    - name: Verify Gradle installation
      run: |
        if [ ! -f "gradlew" ]; then
          echo "‚ùå All Gradle installations failed"
          exit 1
        fi
        echo "üìä Gradle version:"
        ./gradlew --version
        echo ""
        echo "‚úÖ Using Gradle: ${{ steps.gradle_primary.outputs.version || steps.gradle_fallback1.outputs.version || steps.gradle_fallback2.outputs.version }}"
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Run Gradle clean
      run: |
        echo "üßπ Cleaning build..."
        ./gradlew clean --stacktrace
          
    - name: Run tests
      id: test
      continue-on-error: true
      run: |
        echo "üß™ Running tests..."
        ./gradlew test --stacktrace || echo "‚ö†Ô∏è Tests failed but continuing"
        
    - name: Build Debug APK
      id: build_debug
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
      run: |
        echo "üî® Building Debug APK..."
        ./gradlew assembleDebug --stacktrace --no-daemon --info
        
        DEBUG_APK=$(find app/build/outputs/apk/debug -name '*.apk' | head -n 1)
        if [ -n "$DEBUG_APK" ] && [ -f "$DEBUG_APK" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "apk_path=$DEBUG_APK" >> $GITHUB_OUTPUT
          echo "‚úÖ Debug APK built: $DEBUG_APK"
          ls -lh "$DEBUG_APK"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ùå Debug APK not found"
          exit 1
        fi
        
    - name: Build Release APK
      id: build_release
      if: github.event.inputs.build_type == 'release' || github.event.inputs.build_type == 'both' || github.event.inputs.build_type == ''
      run: |
        echo "üî® Building Release APK..."
        ./gradlew assembleRelease --stacktrace --no-daemon --info
        
        RELEASE_APK=$(find app/build/outputs/apk/release -name '*.apk' | head -n 1)
        if [ -n "$RELEASE_APK" ] && [ -f "$RELEASE_APK" ]; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "apk_path=$RELEASE_APK" >> $GITHUB_OUTPUT
          echo "‚úÖ Release APK built: $RELEASE_APK"
          ls -lh "$RELEASE_APK"
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "‚ùå Release APK not found"
          exit 1
        fi
      env:
        SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        
    - name: Get version info
      id: version
      run: |
        VERSION_NAME=$(grep -E 'versionName.*=.*"' app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/' || echo "1.0.0")
        VERSION_CODE=$(grep -E 'versionCode.*=.*[0-9]' app/build.gradle.kts | grep -oE '[0-9]+' || echo "1")
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "build_date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        
    - name: Rename APK files
      run: |
        if [ "${{ steps.build_debug.outputs.success }}" == "true" ] && [ -f "${{ steps.build_debug.outputs.apk_path }}" ]; then
          cp "${{ steps.build_debug.outputs.apk_path }}" "NTRLI-DroidForge-debug-v${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.build_date }}.apk"
          echo "‚úÖ Debug APK renamed"
        fi
        if [ "${{ steps.build_release.outputs.success }}" == "true" ] && [ -f "${{ steps.build_release.outputs.apk_path }}" ]; then
          cp "${{ steps.build_release.outputs.apk_path }}" "NTRLI-DroidForge-release-v${{ steps.version.outputs.version_name }}-${{ steps.version.outputs.build_date }}.apk"
          echo "‚úÖ Release APK renamed"
        fi
        
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      if: steps.build_debug.outputs.success == 'true'
      with:
        name: NTRLI-DroidForge-debug-v${{ steps.version.outputs.version_name }}
        path: NTRLI-DroidForge-debug-*.apk
        retention-days: 30
        if-no-files-found: error
        
    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      if: steps.build_release.outputs.success == 'true'
      with:
        name: NTRLI-DroidForge-release-v${{ steps.version.outputs.version_name }}
        path: NTRLI-DroidForge-release-*.apk
        retention-days: 90
        if-no-files-found: error
        
    - name: Generate build summary
      if: always()
      run: |
        echo "# üöÄ NTRLI DroidForge Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Code:** ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** ${{ steps.version.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Gradle Version:** ${{ steps.gradle_primary.outputs.version || steps.gradle_fallback1.outputs.version || steps.gradle_fallback2.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.build_debug.outputs.success }}" == "true" ]; then
          echo "- ‚úÖ **Debug APK** built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ùå **Debug APK** build failed" >> $GITHUB_STEP_SUMMARY
        fi
        if [ "${{ steps.build_release.outputs.success }}" == "true" ]; then
          echo "- ‚úÖ **Release APK** built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ùå **Release APK** build failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üåø Built with precision. No compromises." >> $GITHUB_STEP_SUMMARY
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 14
        if-no-files-found: ignore
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-failure
        path: |
          app/build/reports/
          build/reports/
          app/build/outputs/logs/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: Cleanup Gradle Cache
      if: always()
      run: |
        rm -f ~/.gradle/caches/modules-2/modules-2.lock
        rm -f ~/.gradle/caches/modules-2/gc.properties

  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          NTRLI-DroidForge-release-*/*.apk
          NTRLI-DroidForge-debug-*/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üöÄ NTRLI DroidForge Release
          
          Professional Android application built with precision.
          
          ### üì¶ Downloads
          - **Release APK**: Production-ready, optimized build
          - **Debug APK**: Development build with debugging enabled
          
          ### üìù Installation
          1. Download the appropriate APK file
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install the APK on your device
          
          ### üîß Technical Details
          - **Gradle**: 8.13 (Latest Stable)
          - **AGP**: 8.13.2
          - **Kotlin**: 2.2.21
          - **Min SDK**: 24 (Android 7.0)
          - **Target SDK**: 36 (Android 15+)
          
          üåø Built with precision. No compromises.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
