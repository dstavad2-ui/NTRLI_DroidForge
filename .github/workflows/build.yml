name: NTRLI God-Mode Self-Healing Forge
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  forge_and_mutate:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      ANDROID_HOME: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_HOME: ${{ github.workspace }}/android-ndk
      # Path injection to force Buildozer to use our validated tools
      BUILDOZER_SDK_PATH: ${{ github.workspace }}/android-sdk
      BUILDOZER_NDK_PATH: ${{ github.workspace }}/android-ndk

    steps:
      - name: üöÄ 1. Mobile Sync
        uses: actions/checkout@v4

      - name: ‚òï 2. Java 17 Enforcement
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: üß¨ 3. God-Mode Dependency Injection (Fix for Log 59020186173)
        run: |
          echo "Installing all missing headers and architecture shims..."
          sudo dpkg --add-architecture i386
          sudo apt-get update -qq
          # Installing every single missing item identified in recent failures
          sudo apt-get install -y -qq \
            build-essential ccache cmake curl git libffi-dev libssl-dev \
            libstdc++6:i386 lib32z1 lib32stdc++6 libncurses5:i386 \
            openjdk-17-jdk python3-dev python3-pip unzip zip zlib1g-dev \
            autoconf automake libtool pkg-config lld
          
          # AUTO-GENERATION: Create spec if it doesn't exist
          if [ ! -f "buildozer.spec" ]; then
            pip3 install --user buildozer
            ~/.local/bin/buildozer init
          fi

          # SELF-HEAL: Force alignment with verified 2025 paths
          sed -i 's|^android.api = .*|android.api = 33|g' buildozer.spec
          sed -i 's|^android.sdk = .*|android.sdk = 33|g' buildozer.spec
          sed -i 's|^android.ndk = .*|android.ndk = 25b|g' buildozer.spec
          sed -i 's|^android.build_tools_version = .*|android.build_tools_version = 33.0.2|g' buildozer.spec
          sed -i 's|^android.accept_sdk_license = .*|android.accept_sdk_license = True|g' buildozer.spec
          sed -i 's|^requirements = .*|requirements = python3,kivy,android,openai,mistralai|g' buildozer.spec
          
          # Live Correction Push
          git config --global user.name "NTRLI-GodBot"
          git config --global user.email "bot@ntrli.ai"
          git add buildozer.spec
          git diff --staged --quiet || (git commit -m "ü§ñ God-Mode: Full Dependency & Spec Restoration" && git push origin main)

      - name: üõ∞Ô∏è 4. SDK/NDK Manual Construction
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          curl -sS -L https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline.zip
          unzip -q cmdline.zip -d $ANDROID_HOME/cmdline-tools && mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          
          curl -sS -L https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -o ndk.zip
          unzip -q ndk.zip -d ${{ github.workspace }} && mv ${{ github.workspace }}/android-ndk-r25b $ANDROID_NDK_HOME
          
          echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools" >> $GITHUB_ENV

      - name: üõ°Ô∏è 5. Pre-Flight Integrity Audit
        run: |
          chmod -R +x ${{ github.workspace }}
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses --sdk_root=$ANDROID_HOME
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_HOME "platforms;android-33" "build-tools;33.0.2"
          # Verify the tool that failed in previous logs
          $ANDROID_HOME/build-tools/33.0.2/aidl -version || exit 1

      - name: üß™ 6. Execution (Path-Locked Mode)
        run: |
          pip3 install --user --upgrade buildozer cython==0.29.33
          # Path injection overrides buildozer's internal drift
          ~/.local/bin/buildozer -v android release
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: üì¶ 7. Production Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          files: bin/*.apk
          token: ${{ github.token }}
