name: NTRLI Absolute Validated Forge
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  forge_and_mutate:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      ANDROID_HOME: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_HOME: ${{ github.workspace }}/android-ndk
      BUILDOZER_BIN: /home/runner/.local/bin/buildozer
      # Absolute Override: Forcing Buildozer to use our verified tools
      BUILDOZER_SDK_PATH: ${{ github.workspace }}/android-sdk
      BUILDOZER_NDK_PATH: ${{ github.workspace }}/android-ndk

    steps:
      - name: ðŸš€ 1. Atomic Sync
        uses: actions/checkout@v4

      - name: â˜• 2. Java 17 Enforcement (Zulu 61 Protocol)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ§¬ 3. System Dependency Injection
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update -qq
          sudo apt-get install -y -qq build-essential ccache cmake curl git \
            libffi-dev libssl-dev libstdc++6:i386 lib32z1 lib32stdc++6 \
            libncurses5:i386 openjdk-17-jdk python3-dev python3-pip unzip zip \
            zlib1g-dev autoconf automake libtool pkg-config lld rsync
          pip3 install --user --upgrade buildozer cython==0.29.33
          echo "/home/runner/.local/bin" >> $GITHUB_PATH

      - name: ðŸ›°ï¸ 4. SDK Atomic Construction (Validated Structure)
        run: |
          rm -rf $ANDROID_HOME $ANDROID_NDK_HOME temp_sdk
          mkdir -p $ANDROID_HOME/cmdline-tools/latest
          
          # Verified 2025 Command-Line Tools
          curl -sS -L https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline.zip
          unzip -q cmdline.zip -d temp_sdk
          
          # Validated Fix: Standard move logic often creates double-nesting. 
          # We use rsync/cp to ensure contents of 'cmdline-tools' map to 'latest'
          cp -r temp_sdk/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
          
          curl -sS -L https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -o ndk.zip
          unzip -q ndk.zip
          mv android-ndk-r25b $ANDROID_NDK_HOME
          rm -rf temp_sdk cmdline.zip ndk.zip

      - name: ðŸ›¡ï¸ 5. Integrity Audit & Permission Sovereignty
        run: |
          SDK_MGR=$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager
          chmod +x $SDK_MGR
          
          # Force accept licenses via Absolute SDK Root
          yes | $SDK_MGR --sdk_root=$ANDROID_HOME --licenses
          $SDK_MGR --sdk_root=$ANDROID_HOME "platforms;android-33" "build-tools;33.0.2" "platform-tools"
          
          # Absolute Sovereignty: Strip OS of write-protection
          sudo chmod -R 777 $GITHUB_WORKSPACE
          $ANDROID_HOME/build-tools/33.0.2/aidl -version || exit 1

      - name: ðŸ§ª 6. Path-Locked Execution (Zero-Failure Mutation)
        run: |
          if [ ! -f "buildozer.spec" ]; then $BUILDOZER_BIN init; fi
          
          # Force Spec to align with 2025 verified environment
          sed -i "s|^#\?android.sdk_path = .*|android.sdk_path = $ANDROID_HOME|g" buildozer.spec
          sed -i "s|^#\?android.ndk_path = .*|android.ndk_path = $ANDROID_NDK_HOME|g" buildozer.spec
          sed -i "s|^#\?android.accept_sdk_license = .*|android.accept_sdk_license = True|g" buildozer.spec
          sed -i "s|^#\?android.api = .*|android.api = 33|g" buildozer.spec
          
          # VALIDATED REQUIREMENTS: Added 'openssl' and 'requests' for AI stability
          sed -i "s|^requirements = .*|requirements = python3,kivy,android,openai,mistralai,urllib3==1.26.15,certifi,charset-normalizer,openssl,requests|g" buildozer.spec
          
          # VALIDATED PERMISSIONS: Ensuring AI can talk to the web
          sed -i "s|^#\?android.permissions = .*|android.permissions = INTERNET,ACCESS_NETWORK_STATE|g" buildozer.spec
          
          export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/33.0.2:/home/runner/.local/bin:$PATH
          $BUILDOZER_BIN -v android release 2>&1 | tee build_logs.txt
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: ðŸ“Š 7. Final Resilience Report
        if: always()
        run: |
          echo "### ðŸ“± NTRLI Absolute God-Mode Report" >> $GITHUB_STEP_SUMMARY
          if [ -d "bin" ] && [ "$(ls -A bin/*.apk 2>/dev/null)" ]; then
            echo "âœ… **DOMINANCE ACHIEVED: APK FORGED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **BUILD RESISTANCE DETECTED**" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            [ -f build_logs.txt ] && tail -n 50 build_logs.txt >> $GITHUB_STEP_SUMMARY || echo "No logs found." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¦ 8. Instant Mobile Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ github.run_id }}
          files: bin/*.apk
          token: ${{ github.token }}
